<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:og="http://ogp.me/ns#"
      xmlns:fb="https://www.facebook.com/2008/fbml">
<head>
    <title>unittest API, part 2 - Mere Code</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    

    <!-- Open Graph tags -->
            <meta property="og:type" content="article"/>
            <meta property="og:title" content="unittest API, part 2"/>
            <meta property="og:url" content="http://code.mumak.net/2010/08/unittest-api-part-2.html"/>
            <meta property="og:description" content="In part 1 of this humble attempt to document the interfaces and contracts that unittest actually cares about, we talked about TestSuite and TestCase, how they both implement a common interface that's used for running tests, ITest and how they each implement their own interfaces, ITestSuite and ITestCase. Now ..."/>

    <!-- Bootstrap -->
        <link rel="stylesheet" href="http://code.mumak.net/theme/css/bootstrap.yeti.min.css" type="text/css"/>
    <link href="http://code.mumak.net/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="http://code.mumak.net/theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="http://code.mumak.net/theme/css/style.css" type="text/css"/>

        <link href="http://code.mumak.net/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Mere Code ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://code.mumak.net/" class="navbar-brand">
Mere Code            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="http://code.mumak.net/blog/archives/"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<div class="container">
    <div class="row">
        <div class="col-sm-9">

    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="http://code.mumak.net/2010/08/unittest-api-part-2.html"
                       rel="bookmark"
                       title="Permalink to unittest API, part 2">
                        unittest API, part 2
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2010-08-02T11:15:00"> Mon 02 August 2010</time>
    </span>



    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>In <a href="http://code.mumak.net/2010/07/unittest-api-part-1.html">part 1</a> of
this humble attempt to document the interfaces and contracts that
unittest actually cares about, we talked about <code>TestSuite</code> and
<code>TestCase</code>, how they both implement a common interface that's used for
running tests, <strong><code>ITest</code></strong> and how they each implement their own
interfaces, <strong><code>ITestSuite</code></strong> and <strong><code>ITestCase</code></strong>.  </p>
<p>Now we're moving on to a much more complicated object, <code>TestResult</code>, to
see how we can pick apart the ways it interacts with the rest of the
system.  </p>
<p><strong><code>TestResult</code></strong>  </p>
<p>A <code>TestResult</code> object is all about dealing with the results of tests, as
you might expect. However, it doesn't generally represent a <em>single</em>
test result. You could say it represents the results of a number of
tests, but I don't think that's terribly helpful.  </p>
<p>Better to think of a <code>TestResult</code> object as an event handler. A
<code>TestResult</code> object receives events from a test run and then does
something with them.  </p>
<p>Just as <code>TestCase</code> has a two-faced nature, presenting one interface to
the testing framework and another to test authors, so to <code>TestResult</code>
can be thought of has having many interfaces:  </p>
<ol>
<li>Its interface to a <code>TestCase</code>. This can be thought of as the <em>test
    event handling</em> interface</li>
<li>A <em>result querying</em> interface, normally used by a test runner</li>
<li>An interface for events that come from the test runner, the <em>runner
    event handling</em> interface.</li>
<li>An <em>execution control</em> interface.</li>
</ol>
<p>Note that the <em>result querying</em> interface and the <em>runner event
handling</em> interface together make up the interface between the
<code>TestResult</code> and test runner.  </p>
<p>Let's start with the <em>test event handling</em> interface. The methods below
are the interface between <code>TestCase.run()</code> and <code>TestResult</code>. (I guess
<code>TestCase.debug</code> too, but no one cares about it).  </p>
<dl>
<dt><code>startTest(test)</code></dt>
<dd>Called when <code>test</code> commences running. Although not enforced, it's
impolite to provide any results for <code>test</code> before calling this.</dd>
<dt><code>stopTest(test)</code></dt>
<dd>Called when <code>test</code> is completely finished. Although not enforced,
it's impolite to provide any more results for <code>test</code> after calling
this, unless you call <code>startTest(test)</code> again first.</dd>
<dt><code>addSuccess(test)</code></dt>
<dd>Called when <code>test</code> has been shown to be successful. The default
implementation does nothing.</dd>
<dt><code>addError(test, err)</code></dt>
<dd>Called when <code>test</code> raises an unexpected error. <code>err</code> is a tuple such
as you might get from <code>sys.exc_info()</code>. Calling this method for the
first time must change the result of <code>wasSuccessful()</code>.</dd>
<dt><code>addFailure(test, err)</code></dt>
<dd>Called when <code>test</code> has failed one of its assertions. <code>err</code> is a
tuple such as you might get from <code>sys.exc_info()</code>.</dd>
</dl>
<p>The above interface is tightly coupled to the implementation of
<code>TestCase.run()</code>. In particular, if you wish to add more kinds of
results to your testing framework ("skip" results are a fairly common
addition), then you must change both <code>TestCase.run()</code> and the
<code>TestResult</code> interface.  </p>
<p>If you do something like that, I recommend making sure that your
modified <code>TestCase</code> can handle <code>TestResult</code> objects that do not provide
the extensions to the interface that you need. One common way of doing
this is to have the <code>TestCase</code> fall back to the primitive result types,
e.g. "skip" might become "success" for a <code>TestResult</code> that doesn't know
what skipping means.  </p>
<p>Importantly, the interface between <code>TestCase</code> and <code>TestResult</code> has been
fattened in Python 2.7.  </p>
<dl>
<dt><code>addSkip(test, reason)</code></dt>
<dd>Called when <code>test</code> is skipped. <code>reason</code> is a string explaining why
the test was skipped.</dd>
<dt><code>addExpectedFailure(test, err)</code></dt>
<dd>Called when <code>test</code> failed in a way that was expected. <code>err</code> is a
tuple such as the one returned by <code>sys.exc_info()</code>.</dd>
<dt><code>addUnexpectedSuccess(test)</code></dt>
<dd>Called when <code>test</code> was expected to fail, but didn't.</dd>
</dl>
<p>The following interface is a way of learning about test results after
they have happened, the <em>result querying</em> interface, and is part of the
contract between the test runner and the TestResult.  </p>
<dl>
<dt><code>wasSuccessful()</code></dt>
<dd>If there have been no errors and no failures, return <code>True</code>. Return
<code>False</code> otherwise.</dd>
<dt><code>testsRun</code></dt>
<dd>
<dl>
<dt>An integer that is the number of tests that have been run.</dt>
<dt><code>errors</code></dt>
<dd>A list of tuples of <code>(test, error_message)</code> for all of the tests
with unexpected errors, where <code>test</code> is an <code>ITestCase</code> and
<code>error_message</code> is a string suitable for display to humans,
generally containing a traceback.</dd>
<dt><code>failures</code></dt>
<dd>A list of tuples of <code>(test, error_message)</code> for all of the failing
tests, where <code>test</code> is an <code>ITestCase</code> and <code>error_message</code> is a
string suitable for display to humans, generally containing a
traceback.</dd>
</dl>
</dd>
</dl>
<p>And of course, Python 2.7 fattens this interface again to have the
following:  </p>
<dl>
<dt><code>skipped</code></dt>
<dd>A list of tuples of <code>(test, reason)</code> for all of the skipped tests,
where <code>test</code> is an <code>ITestCase</code> and <code>reason</code> is a string suitable for
display to humans, generally containing a traceback.</dd>
<dt><code>expectedFailures</code></dt>
<dd>A list of tuples of <code>(test, error_message)</code> for all of the tests
that were expected to fail and failed in the manner they were
expected to, where <code>test</code> is an <code>ITestCase</code> and <code>error_message</code> is a
string suitable for display to humans, generally containing a
traceback.</dd>
<dt><code>unexpectedSuccesses</code></dt>
<dd>A list of all of the tests that unexpectedly succeeded. Members of
the list are <code>ITestCase</code>s.</dd>
</dl>
<p>In Python 2.7, <code>TestResult</code> also extended its interface to the test
runner beyond simple result querying and into allowing the test runner
itself to send two very important events to the <code>TestResult</code>, behold the
<em>runner event handling</em> interface:  </p>
<dl>
<dt><code>startTestRun()</code></dt>
<dd>
<p><div
style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"></p>
<p>Called before any tests have been run. It is impolite to provide any
test results before calling this.</p>
</div>

</dd>
<dt><code>stopTestRun()</code></dt>
<dd>
<p><div
style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"></p>
<p>Called after all the tests have finished running. It is impolite to
provide any test results after calling this. A <code>TestResult</code> object
is generally not expected to handle any events at all after this
method has been called.</p>
</div>

</dd>
</dl>
<p>Some test runners rely on <code>TestResult</code>s to use those events to display
the results to the user. These runners frequently do not use the result
querying part of the interface.  </p>
<p>There is one more interface that <code>TestResult</code> implements: the <em>execution
control</em> interface:  </p>
<dl>
<dt>
`stop()`

</dt>
<dd>
Signal that the execution of further tests should stop now. Sets
`shouldStop` to `True`.

</dd>
<dt>
`shouldStop`

</dt>
<dd>
If `True`, then test execution should stop. `TestSuite.run()` should
monitor this value and stop execution if ever it is `True`.

</dd>
<dt>
</dt>
</dl>

<p>This interface is mostly used as a way of handling <code>KeyboardInterrupt</code>s
cleanly.  </p>
<p><strong>Summary</strong>  </p>
<p>If you want your <code>TestResult</code> object to work with standard Python
<code>TestCase</code> objects, or any <code>TestCase</code> objects that try to stick close to
the standard, then you must provide the <em>test event handling</em> interface
described above. If you are writing your own test framework or test
runner, you care about this, because you want to run everyone's unit
tests.  </p>
<p>If you want your <code>TestResult</code> object to work with the standard Python
test runner before Python 2.7, then you must provide the <em>result
querying</em> interface. If you are using the standard Python test runner,
you care about this. For Trial or testtools, you must provide the
<em>runner event handling</em> interface. For anything else, I'm afraid you are
on your own.  </p>
<p>Always provide the <em>execution control</em> interface.  </p>
<p><strong>Comments</strong>  </p>
<p>In this documentation, I've been trying to describe the various
interfaces without inserting too much of my own opinion about their
design. However, I think some commentary might actually help to make
things easier to understand.  </p>
<p>By providing a querying interface for <code>TestResult</code> to be used by a test
runner, the original designers of unittest practically insisted that
responsibility for displaying the results of a test run be split between
two different classes. The <code>TestResult</code> takes care of displaying
incremental feedback from the running tests and the test runner takes
care of displaying the summary. You can see evidence of this design in
Python 2.6's unittest.py, where there's a hidden <code>_TextTestResult</code>
subclass which has extra methods that are called only by a special
<code>TextTestRunner</code>.  </p>
<p>The addition of <code>startTestRun()</code> and <code>stopTestRun()</code> mean that now a
<code>TestResult</code> object can be fully in charge of displaying its results. As
such, providing a query interface and exposing details like the list of
test failures somewhat vestigial.  </p>
<p>I'm less happy with this post than the previous one. As such your
critique is even more welcome.  </p>
<p>Still to come: the interface for test authors and just what is a test
runner anyway?  </p>
<p><strong>Update:</strong> Remove ambiguity in <code>expectedFailures</code> description (see
comments). Thanks Aaron.</p>
            </div>
            <!-- /.entry-content -->

    <hr />
    <section class="comments">
      <h2>Comments</h2>

            <article id="comment-6483064864510876793.md">
                <a href="http://code.mumak.net/2010/08/unittest-api-part-2.html#comment-6483064864510876793.md" rel="bookmark" title="Permalink to this comment">Permalink</a>
                <h4>Aaron (noreply@blogger.com)</h4>
                <p>Posted on <abbr class="published" title="2010-07-30T18:36:00">Fri 30 July 2010</abbr></p>
                
                <p>In your description of expectedFailures:<br />
<em>A list of tuples of (test, error_message) for all of the tests that
were expected to fail, where test is an ITestCase and error_message is
a string suitable for display to humans, generally containing a
traceback.</em>  </p>
<p>There is some ambiguity. I think you mean that it is a list of tests
that failed in the expected way, rather that tests that were expected to
fail (whether or not they actually did fail that way).</p>
            </article>
    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3 well well-sm" id="sidebar">

<aside>
    <section>
        <ul class="list-group list-group-flush">



                <li class="list-group-item"><a href="http://code.mumak.net/"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
                    <ul class="list-group" id="tags">
                        <li class="list-group-item tag-1">
                            <a href="http://code.mumak.net/tag/uncategorized.html">
                                Uncategorized
                            </a>
                        </li>
                        <li class="list-group-item tag-2">
                            <a href="http://code.mumak.net/tag/testtools.html">
                                testtools
                            </a>
                        </li>
                        <li class="list-group-item tag-2">
                            <a href="http://code.mumak.net/tag/hacking.html">
                                Hacking
                            </a>
                        </li>
                        <li class="list-group-item tag-2">
                            <a href="http://code.mumak.net/tag/launchpad.html">
                                launchpad
                            </a>
                        </li>
                        <li class="list-group-item tag-2">
                            <a href="http://code.mumak.net/tag/bazaar.html">
                                Bazaar
                            </a>
                        </li>
                        <li class="list-group-item tag-3">
                            <a href="http://code.mumak.net/tag/testing.html">
                                Testing
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://code.mumak.net/tag/ubuntu.html">
                                ubuntu
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://code.mumak.net/tag/pelican.html">
                                pelican
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://code.mumak.net/tag/launchpad-subunit-data.html">
                                launchpad subunit data
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://code.mumak.net/tag/twisted.html">
                                Twisted
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://code.mumak.net/tag/subunit-data.html">
                                subunit data
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://code.mumak.net/tag/ui.html">
                                UI
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://code.mumak.net/tag/personal.html">
                                Personal
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://code.mumak.net/tag/blog.html">
                                blog
                            </a>
                        </li>
                    </ul>
                </li>    

        </ul>
    </section>

</aside>        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2014 Jonathan M. Lange
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="//code.jquery.com/jquery.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://code.mumak.net/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://code.mumak.net/theme/js/respond.min.js"></script>

</body>
</html>